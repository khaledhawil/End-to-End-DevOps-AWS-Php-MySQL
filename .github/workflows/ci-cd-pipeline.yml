name: CI/CD Pipeline - Service Change Detection

# Triggers on changes to service directories or this workflow file
# Note: Dockerfile changes will trigger builds since they require image rebuilds
on:
  push:
    branches: [master, develop]
    paths:
      - 'services/auth-service/**'
      - 'services/task-service/**'
      - 'services/frontend/**'
      - 'services/nginx/**'
      - '.github/workflows/ci-cd-pipeline.yml'
  pull_request:
    branches: [master, develop]
    paths:
      - 'services/auth-service/**'
      - 'services/task-service/**'
      - 'services/frontend/**'
      - 'services/nginx/**'

permissions:
  contents: write
  security-events: write
  actions: read

env:
  DOCKER_REGISTRY: docker.io  # Change to your ECR URL for AWS ECR
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  AWS_REGION: us-east-1
  VERSION_MAJOR: 1
  VERSION_MINOR: 0

jobs:
  # Job 0: Generate Version Number
  generate-version:
    name: Generate Version Number
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_tag: ${{ steps.version.outputs.version_tag }}
    steps:
      - name: Generate semantic version
        id: version
        run: |
          # Generate version based on run number: MAJOR.MINOR.PATCH
          MAJOR=${{ env.VERSION_MAJOR }}
          MINOR=${{ env.VERSION_MINOR }}
          PATCH=${{ github.run_number }}
          
          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_tag=v${VERSION}" >> $GITHUB_OUTPUT
          
          echo "Generated version: ${VERSION}"
          echo "Version tag: v${VERSION}"

  # Job 1: Pipeline Started Notification
  pipeline-started:
    name: Pipeline Started Notification
    needs: generate-version
    runs-on: ubuntu-latest
    steps:
      - name: Send Pipeline Started notification to Slack
        continue-on-error: true
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "‚ö†Ô∏è  SLACK_WEBHOOK_URL secret not configured. Skipping Slack notification."
            exit 0
          fi
          
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \":rocket: CI/CD Pipeline Started\",
                    \"emoji\": true
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"New pipeline execution started for *${{ github.repository }}*\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch*\\n\`${{ github.ref_name }}\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Triggered By*\\n${{ github.actor }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Event*\\n${{ github.event_name }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Workflow*\\n${{ github.workflow }}\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Commit:* <${{ github.event.repository.html_url }}/commit/${{ github.sha }}|\`${GITHUB_SHA:0:7}\`>\\n*Commit Message:* ${{ github.event.head_commit.message }}\\n*Version:* \`${{ needs.generate-version.outputs.version }}\`\\n*View Run:* <${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}|Click here>\"
                  }
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"GitHub Actions ‚Ä¢ $(date -u +'%Y-%m-%d %H:%M:%S UTC')\"
                    }
                  ]
                }
              ]
            }"
          
          echo "‚úÖ Pipeline started notification sent"

  # Job 2: Detect which services have changed
  detect-changes:
    name: Detect Changed Services
    needs: [generate-version, pipeline-started]
    runs-on: ubuntu-latest
    outputs:
      auth-service: ${{ steps.filter.outputs.auth-service }}
      task-service: ${{ steps.filter.outputs.task-service }}
      frontend: ${{ steps.filter.outputs.frontend }}
      nginx: ${{ steps.filter.outputs.nginx }}
      any-change: ${{ steps.filter.outputs.any-change }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for service changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth-service:
              - 'services/auth-service/**'
            task-service:
              - 'services/task-service/**'
            frontend:
              - 'services/frontend/**'
            nginx:
              - 'services/nginx/**'
            any-change:
              - 'services/**'

      - name: Display detected changes
        run: |
          echo "üîç Change Detection Results:"
          echo "Auth Service Changed: ${{ steps.filter.outputs.auth-service }}"
          echo "Task Service Changed: ${{ steps.filter.outputs.task-service }}"
          echo "Frontend Changed: ${{ steps.filter.outputs.frontend }}"
          echo "Nginx Changed: ${{ steps.filter.outputs.nginx }}"

  # Job 3: Build and push Auth Service
  build-auth-service:
    name: Build Auth Service
    needs: [generate-version, detect-changes]
    if: needs.detect-changes.outputs.auth-service == 'true'
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.build-status.outputs.success }}
      version: ${{ needs.generate-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Uncomment for AWS ECR
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: ${{ env.AWS_REGION }}
      #
      # - name: Login to Amazon ECR
      #   id: login-ecr
      #   uses: aws-actions/amazon-ecr-login@v2

      - name: Build Auth Service Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./services/auth-service
          push: false
          tags: |
            ${{ env.DOCKER_USERNAME }}/task-manager-auth:${{ needs.generate-version.outputs.version }}
            ${{ env.DOCKER_USERNAME }}/task-manager-auth:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
          provenance: false
          sbom: false

      - name: Generate SBOM for Auth Service
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.DOCKER_USERNAME }}/task-manager-auth:${{ needs.generate-version.outputs.version }}
          format: spdx-json
          output-file: auth-sbom.spdx.json

      - name: Scan Auth Service SBOM with Grype
        uses: anchore/scan-action@v3
        continue-on-error: true
        with:
          sbom: auth-sbom.spdx.json
          fail-build: false
          severity-cutoff: high

      - name: Scan Auth Service image with Trivy (SARIF)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-auth:${{ needs.generate-version.outputs.version }}
          format: 'sarif'
          output: 'trivy-auth-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Scan Auth Service image with Trivy (JSON)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-auth:${{ needs.generate-version.outputs.version }}
          format: 'json'
          output: 'trivy-auth-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-auth-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-auth-results.sarif'
          category: 'auth-service'

      - name: Upload Trivy JSON results as artifact
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('trivy-auth-results.json') != ''
        with:
          name: trivy-auth-results
          path: trivy-auth-results.json

      - name: Scan for secrets in Auth Service
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: './services/auth-service'
          scanners: 'secret'
          format: 'table'

      - name: Check Auth Service image for security best practices
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image --security-checks config \
            ${{ env.DOCKER_USERNAME }}/task-manager-auth:${{ needs.generate-version.outputs.version }}

      - name: Upload Auth Service SBOM
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('auth-sbom.spdx.json') != ''
        with:
          name: auth-sbom
          path: auth-sbom.spdx.json

      - name: Push Auth Service image
        id: push
        run: |
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-auth:${{ needs.generate-version.outputs.version }}
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-auth:latest

      - name: Save image tag for K8s update
        run: |
          mkdir -p artifacts
          echo "${{ needs.generate-version.outputs.version }}" > artifacts/auth-service-tag.txt
          echo "auth-service" > artifacts/auth-service-name.txt

      - name: Mark build as successful
        id: build-status
        if: success()
        run: |
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: auth-service-artifacts
          path: artifacts/

  # Job 4: Build and push Task Service
  build-task-service:
    name: Build Task Service
    needs: [generate-version, detect-changes]
    if: needs.detect-changes.outputs.task-service == 'true'
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.build-status.outputs.success }}
      version: ${{ needs.generate-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Task Service Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./services/task-service
          push: false
          tags: |
            ${{ env.DOCKER_USERNAME }}/task-manager-task:${{ needs.generate-version.outputs.version }}
            ${{ env.DOCKER_USERNAME }}/task-manager-task:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
          provenance: false
          sbom: false

      - name: Scan Task Service image with Trivy (SARIF)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-task:${{ needs.generate-version.outputs.version }}
          format: 'sarif'
          output: 'trivy-task-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Scan Task Service image with Trivy (JSON)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-task:${{ needs.generate-version.outputs.version }}
          format: 'json'
          output: 'trivy-task-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-task-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-task-results.sarif'
          category: 'task-service'

      - name: Upload Trivy JSON results as artifact
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('trivy-task-results.json') != ''
        with:
          name: trivy-task-results
          path: trivy-task-results.json

      - name: Push Task Service image
        id: push
        run: |
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-task:${{ needs.generate-version.outputs.version }}
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-task:latest

      - name: Save image tag for K8s update
        run: |
          mkdir -p artifacts
          echo "${{ needs.generate-version.outputs.version }}" > artifacts/task-service-tag.txt
          echo "task-service" > artifacts/task-service-name.txt

      - name: Mark build as successful
        id: build-status
        if: success()
        run: |
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: task-service-artifacts
          path: artifacts/

  # Job 5: Build and push Frontend
  build-frontend:
    name: Build Frontend
    needs: [generate-version, detect-changes]
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.build-status.outputs.success }}
      version: ${{ needs.generate-version.outputs.version }}
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Frontend Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./services/frontend
          push: false
          tags: |
            ${{ env.DOCKER_USERNAME }}/task-manager-frontend:${{ needs.generate-version.outputs.version }}
            ${{ env.DOCKER_USERNAME }}/task-manager-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
          provenance: false
          sbom: false

      - name: Scan Frontend image with Trivy (SARIF)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-frontend:${{ needs.generate-version.outputs.version }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Scan Frontend image with Trivy (JSON)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-frontend:${{ needs.generate-version.outputs.version }}
          format: 'json'
          output: 'trivy-frontend-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-frontend-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'frontend'

      - name: Upload Trivy JSON results as artifact
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('trivy-frontend-results.json') != ''
        with:
          name: trivy-frontend-results
          path: trivy-frontend-results.json

      - name: Push Frontend image
        id: push
        run: |
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-frontend:${{ needs.generate-version.outputs.version }}
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-frontend:latest

      - name: Save image tag for K8s update
        run: |
          mkdir -p artifacts
          echo "${{ needs.generate-version.outputs.version }}" > artifacts/frontend-tag.txt
          echo "frontend" > artifacts/frontend-name.txt

      - name: Mark build as successful
        id: build-status
        if: success()
        run: |
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: frontend-artifacts
          path: artifacts/

  # Job 6: Build and push Nginx
  build-nginx:
    name: Build Nginx
    needs: [generate-version, detect-changes]
    if: needs.detect-changes.outputs.nginx == 'true'
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.build-status.outputs.success }}
      version: ${{ needs.generate-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Nginx Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./services/nginx
          push: false
          tags: |
            ${{ env.DOCKER_USERNAME }}/task-manager-nginx:${{ needs.generate-version.outputs.version }}
            ${{ env.DOCKER_USERNAME }}/task-manager-nginx:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
          provenance: false
          sbom: false

      - name: Scan Nginx image with Trivy (SARIF)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-nginx:${{ needs.generate-version.outputs.version }}
          format: 'sarif'
          output: 'trivy-nginx-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Scan Nginx image with Trivy (JSON)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-nginx:${{ needs.generate-version.outputs.version }}
          format: 'json'
          output: 'trivy-nginx-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-nginx-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-nginx-results.sarif'
          category: 'nginx'

      - name: Upload Trivy JSON results as artifact
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('trivy-nginx-results.json') != ''
        with:
          name: trivy-nginx-results
          path: trivy-nginx-results.json

      - name: Push Nginx image
        id: push
        run: |
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-nginx:${{ needs.generate-version.outputs.version }}
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-nginx:latest

      - name: Save image tag for K8s update
        run: |
          mkdir -p artifacts
          echo "${{ needs.generate-version.outputs.version }}" > artifacts/nginx-tag.txt
          echo "nginx" > artifacts/nginx-name.txt

      - name: Mark build as successful
        id: build-status
        if: success()
        run: |
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: nginx-artifacts
          path: artifacts/

  # Job 7: Collect vulnerabilities and send notifications
  vulnerability-notification:
    name: Vulnerability Notification
    needs: [generate-version, detect-changes, build-auth-service, build-task-service, build-frontend, build-nginx]
    if: |
      always() && 
      needs.detect-changes.outputs.any-change == 'true' &&
      (needs.build-auth-service.result == 'success' || 
       needs.build-task-service.result == 'success' || 
       needs.build-frontend.result == 'success' || 
       needs.build-nginx.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Download all Trivy results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: trivy-results/

      - name: Parse vulnerabilities and generate report
        id: parse-vulns
        run: |
          echo "üîç Parsing Trivy scan results..."
          
          # Initialize counters
          TOTAL_CRITICAL=0
          TOTAL_HIGH=0
          TOTAL_MEDIUM=0
          
          # Create report file
          REPORT_FILE="vulnerability-report.md"
          echo "# üîí Security Vulnerability Report" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Repository:** ${{ github.repository }}" >> $REPORT_FILE
          echo "**Commit:** ${{ github.sha }}" >> $REPORT_FILE
          echo "**Branch:** ${{ github.ref_name }}" >> $REPORT_FILE
          echo "**Scan Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          # Process each service's Trivy results
          for service_dir in trivy-results/trivy-*-results; do
            if [ -d "$service_dir" ]; then
              SERVICE_NAME=$(basename "$service_dir" | sed 's/trivy-//;s/-results//')
              JSON_FILE="$service_dir/trivy-${SERVICE_NAME}-results.json"
              
              if [ -f "$JSON_FILE" ]; then
                echo "Processing $SERVICE_NAME..."
                
                # Count vulnerabilities by severity
                CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$JSON_FILE" 2>/dev/null || echo 0)
                HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$JSON_FILE" 2>/dev/null || echo 0)
                MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$JSON_FILE" 2>/dev/null || echo 0)
                
                TOTAL_CRITICAL=$((TOTAL_CRITICAL + CRITICAL))
                TOTAL_HIGH=$((TOTAL_HIGH + HIGH))
                TOTAL_MEDIUM=$((TOTAL_MEDIUM + MEDIUM))
                
                # Add service section to report
                echo "## üì¶ ${SERVICE_NAME^^} Service" >> $REPORT_FILE
                echo "" >> $REPORT_FILE
                echo "| Severity | Count |" >> $REPORT_FILE
                echo "|----------|-------|" >> $REPORT_FILE
                echo "| üî¥ CRITICAL | $CRITICAL |" >> $REPORT_FILE
                echo "| üü† HIGH | $HIGH |" >> $REPORT_FILE
                echo "| üü° MEDIUM | $MEDIUM |" >> $REPORT_FILE
                echo "" >> $REPORT_FILE
                
                # List CRITICAL vulnerabilities
                if [ "$CRITICAL" -gt 0 ]; then
                  echo "### üî¥ Critical Vulnerabilities" >> $REPORT_FILE
                  echo "" >> $REPORT_FILE
                  jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") | "- **\(.VulnerabilityID)**: \(.PkgName) (\(.InstalledVersion)) - \(.Title // "No description")"' "$JSON_FILE" 2>/dev/null >> $REPORT_FILE || true
                  echo "" >> $REPORT_FILE
                fi
                
                # List HIGH vulnerabilities
                if [ "$HIGH" -gt 0 ]; then
                  echo "### üü† High Vulnerabilities" >> $REPORT_FILE
                  echo "" >> $REPORT_FILE
                  jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH") | "- **\(.VulnerabilityID)**: \(.PkgName) (\(.InstalledVersion)) - \(.Title // "No description")"' "$JSON_FILE" 2>/dev/null >> $REPORT_FILE || true
                  echo "" >> $REPORT_FILE
                fi
                
                echo "---" >> $REPORT_FILE
                echo "" >> $REPORT_FILE
              fi
            fi
          done
          
          # Add summary
          echo "## üìä Summary" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Total Vulnerabilities Found:**" >> $REPORT_FILE
          echo "- üî¥ Critical: $TOTAL_CRITICAL" >> $REPORT_FILE
          echo "- üü† High: $TOTAL_HIGH" >> $REPORT_FILE
          echo "- üü° Medium: $TOTAL_MEDIUM" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          # Set outputs
          echo "total_critical=$TOTAL_CRITICAL" >> $GITHUB_OUTPUT
          echo "total_high=$TOTAL_HIGH" >> $GITHUB_OUTPUT
          echo "total_medium=$TOTAL_MEDIUM" >> $GITHUB_OUTPUT
          
          # Display report
          cat $REPORT_FILE
          
          echo "‚úÖ Vulnerability report generated"

      - name: Send Slack notification
        if: steps.parse-vulns.outputs.total_critical > 0 || steps.parse-vulns.outputs.total_high > 0
        continue-on-error: true
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "‚ö†Ô∏è  SLACK_WEBHOOK_URL secret not configured. Skipping Slack notification."
            exit 0
          fi
          
          # Determine severity color
          if [ "${{ steps.parse-vulns.outputs.total_critical }}" -gt 0 ]; then
            COLOR="danger"
            STATUS_ICON=":red_circle:"
          elif [ "${{ steps.parse-vulns.outputs.total_high }}" -gt 0 ]; then
            COLOR="warning"
            STATUS_ICON=":warning:"
          else
            COLOR="good"
            STATUS_ICON=":large_yellow_circle:"
          fi
          
          # Determine build services
          SERVICES_BUILT=""
          [ "${{ needs.detect-changes.outputs.auth-service }}" == "true" ] && SERVICES_BUILT="${SERVICES_BUILT}\n‚Ä¢ Auth Service: ${{ needs.build-auth-service.result }}"
          [ "${{ needs.detect-changes.outputs.task-service }}" == "true" ] && SERVICES_BUILT="${SERVICES_BUILT}\n‚Ä¢ Task Service: ${{ needs.build-task-service.result }}"
          [ "${{ needs.detect-changes.outputs.frontend }}" == "true" ] && SERVICES_BUILT="${SERVICES_BUILT}\n‚Ä¢ Frontend: ${{ needs.build-frontend.result }}"
          [ "${{ needs.detect-changes.outputs.nginx }}" == "true" ] && SERVICES_BUILT="${SERVICES_BUILT}\n‚Ä¢ Nginx: ${{ needs.build-nginx.result }}"
          
          # Create Slack message
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"$STATUS_ICON Security Vulnerabilities Detected\",
                    \"emoji\": true
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"Security vulnerabilities found in *${{ github.repository }}*\\n\\n*Services Built:*${SERVICES_BUILT}\"
                  }
                },
                {
                  \"type\": \"divider\"
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*:red_circle: Critical*\\n${{ steps.parse-vulns.outputs.total_critical }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*:orange_circle: High*\\n${{ steps.parse-vulns.outputs.total_high }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*:yellow_circle: Medium*\\n${{ steps.parse-vulns.outputs.total_medium }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch*\\n\`${{ github.ref_name }}\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Triggered By*\\n${{ github.actor }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Workflow*\\n${{ github.workflow }}\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Commit:* <${{ github.event.repository.html_url }}/commit/${{ github.sha }}|\`${{ github.sha }}\`>\\n*View Run:* <${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}|Click here>\"
                  }
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"GitHub Actions ‚Ä¢ $(date -u +'%Y-%m-%d %H:%M:%S UTC')\"
                    }
                  ]
                }
              ]
            }"
          
          echo "‚úÖ Slack notification sent"

      - name: Send email notification
        if: steps.parse-vulns.outputs.total_critical > 0 || steps.parse-vulns.outputs.total_high > 0
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT || '587' }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üîí Security Alert: Vulnerabilities in ${{ github.repository }}"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM || secrets.MAIL_USERNAME }}
          body: file://vulnerability-report.md
          convert_markdown: true
          priority: high

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-report
          path: vulnerability-report.md

  # Job 8: Update K8s manifests with new image tags
  update-k8s-manifests:
    name: Update K8s Manifests
    needs: [generate-version, detect-changes, build-auth-service, build-task-service, build-frontend, build-nginx, vulnerability-notification]
    if: |
      always() && 
      needs.detect-changes.outputs.any-change == 'true' &&
      (needs.build-auth-service.result == 'success' || 
       needs.build-task-service.result == 'success' || 
       needs.build-frontend.result == 'success' || 
       needs.build-nginx.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts/

      - name: Update K8s deployment files
        run: |
          echo "üìù Updating K8s manifests with new image tags (only successful builds)..."
          
          UPDATED_SERVICES=""
          
          # Function to update deployment file - only if build succeeded
          update_deployment() {
            local service=$1
            local deployment_file=$2
            local build_result=$3
            local tag_file="artifacts/${service}-artifacts/${service}-tag.txt"
            
            # Only update if build succeeded
            if [ "$build_result" == "success" ] && [ -f "$tag_file" ]; then
              TAG=$(cat "$tag_file")
              echo "‚úÖ Updating $service to tag: $TAG (build succeeded)"
              
              # Update the image in the deployment file
              sed -i "s|image: .*/task-manager-${service#auth-}:.*|image: ${{ env.DOCKER_USERNAME }}/task-manager-${service#auth-}:${TAG}|g" "$deployment_file"
              
              echo "‚úÖ Updated $deployment_file with new image tag"
              UPDATED_SERVICES="${UPDATED_SERVICES}${service}:${TAG}\n"
            else
              if [ "$build_result" == "failure" ]; then
                echo "‚ùå Skipping $service (build failed - keeping existing tag)"
              else
                echo "‚è≠Ô∏è  Skipping $service (no changes detected)"
              fi
            fi
          }
          
          # Update each service based on build result
          update_deployment "auth" "k8s/base/users-deployment.yaml" "${{ needs.build-auth-service.result }}"
          update_deployment "task" "k8s/base/logout-deployment.yaml" "${{ needs.build-task-service.result }}"
          update_deployment "frontend" "k8s/base/frontend-deployment.yaml" "${{ needs.build-frontend.result }}"
          
          # Display changes
          echo ""
          echo "üìã Changes made:"
          git diff k8s/
          
          # Save updated services for commit message
          echo -e "$UPDATED_SERVICES" > /tmp/updated-services.txt

      - name: Commit and push K8s manifest changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          git add k8s/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Build commit message with only successful builds
            COMMIT_MSG="chore: update K8s manifests with new image tags [skip ci]\n\nVersion: ${{ needs.generate-version.outputs.version }}\n\n"
            
            if [ "${{ needs.build-auth-service.result }}" == "success" ]; then
              COMMIT_MSG="${COMMIT_MSG}- Auth Service: ${{ needs.build-auth-service.outputs.version }}\n"
            fi
            if [ "${{ needs.build-task-service.result }}" == "success" ]; then
              COMMIT_MSG="${COMMIT_MSG}- Task Service: ${{ needs.build-task-service.outputs.version }}\n"
            fi
            if [ "${{ needs.build-frontend.result }}" == "success" ]; then
              COMMIT_MSG="${COMMIT_MSG}- Frontend: ${{ needs.build-frontend.outputs.version }}\n"
            fi
            if [ "${{ needs.build-nginx.result }}" == "success" ]; then
              COMMIT_MSG="${COMMIT_MSG}- Nginx: ${{ needs.build-nginx.outputs.version }}\n"
            fi
            
            COMMIT_MSG="${COMMIT_MSG}\nUpdated by GitHub Actions"
            
            echo -e "$COMMIT_MSG" | git commit -F -
            git push
            echo "‚úÖ K8s manifests updated and pushed"
          fi

  # Job 9: Create summary
  pipeline-summary:
    name: Pipeline Summary
    needs: [generate-version, pipeline-started, detect-changes, build-auth-service, build-task-service, build-frontend, build-nginx, vulnerability-notification, update-k8s-manifests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Pipeline Summary
        run: |
          echo "# üöÄ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîç Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "- Auth Service: ${{ needs.detect-changes.outputs.auth-service == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Task Service: ${{ needs.detect-changes.outputs.task-service == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.detect-changes.outputs.frontend == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Nginx: ${{ needs.detect-changes.outputs.nginx == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üèóÔ∏è Build Results" >> $GITHUB_STEP_SUMMARY
          echo "- Auth Service: ${{ needs.build-auth-service.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Task Service: ${{ needs.build-task-service.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.build-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Nginx: ${{ needs.build-nginx.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîí Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerability Check: ${{ needs.vulnerability-notification.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì¶ K8s Manifest Update" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.update-k8s-manifests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Version & Registry" >> $GITHUB_STEP_SUMMARY
          echo "- Version: \`${{ needs.generate-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Registry: \`${{ env.DOCKER_REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Determine Pipeline Status
        id: status
        run: |
          # Check if any critical job failed
          if [ "${{ needs.build-auth-service.result }}" == "failure" ] || \
             [ "${{ needs.build-task-service.result }}" == "failure" ] || \
             [ "${{ needs.build-frontend.result }}" == "failure" ] || \
             [ "${{ needs.build-nginx.result }}" == "failure" ] || \
             [ "${{ needs.update-k8s-manifests.result }}" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "status_icon=:x:" >> $GITHUB_OUTPUT
            echo "status_text=Failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "status_icon=:white_check_mark:" >> $GITHUB_OUTPUT
            echo "status_text=Successful" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          fi

      - name: Send Pipeline Completion notification to Slack
        continue-on-error: true
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "‚ö†Ô∏è  SLACK_WEBHOOK_URL secret not configured. Skipping Slack notification."
            exit 0
          fi
          
          # Calculate duration
          START_TIME=$(date -d "${{ github.event.head_commit.timestamp }}" +%s 2>/dev/null || date +%s)
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          DURATION_MIN=$((DURATION / 60))
          DURATION_SEC=$((DURATION % 60))
          
          # Build services status
          SERVICES_STATUS=""
          if [ "${{ needs.detect-changes.outputs.auth-service }}" == "true" ]; then
            STATUS_EMOJI=$([ "${{ needs.build-auth-service.result }}" == "success" ] && echo ":white_check_mark:" || echo ":x:")
            SERVICES_STATUS="${SERVICES_STATUS}${STATUS_EMOJI} *Auth Service:* ${{ needs.build-auth-service.result }}\n"
          fi
          if [ "${{ needs.detect-changes.outputs.task-service }}" == "true" ]; then
            STATUS_EMOJI=$([ "${{ needs.build-task-service.result }}" == "success" ] && echo ":white_check_mark:" || echo ":x:")
            SERVICES_STATUS="${SERVICES_STATUS}${STATUS_EMOJI} *Task Service:* ${{ needs.build-task-service.result }}\n"
          fi
          if [ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]; then
            STATUS_EMOJI=$([ "${{ needs.build-frontend.result }}" == "success" ] && echo ":white_check_mark:" || echo ":x:")
            SERVICES_STATUS="${SERVICES_STATUS}${STATUS_EMOJI} *Frontend:* ${{ needs.build-frontend.result }}\n"
          fi
          if [ "${{ needs.detect-changes.outputs.nginx }}" == "true" ]; then
            STATUS_EMOJI=$([ "${{ needs.build-nginx.result }}" == "success" ] && echo ":white_check_mark:" || echo ":x:")
            SERVICES_STATUS="${SERVICES_STATUS}${STATUS_EMOJI} *Nginx:* ${{ needs.build-nginx.result }}\n"
          fi
          
          # If no services were built
          if [ -z "$SERVICES_STATUS" ]; then
            SERVICES_STATUS="No services were built in this pipeline run."
          fi
          
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"${{ steps.status.outputs.status_icon }} Pipeline ${{ steps.status.outputs.status_text }}\",
                    \"emoji\": true
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"Pipeline execution completed for *${{ github.repository }}*\"
                  }
                },
                {
                  \"type\": \"divider\"
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Build Results:*\n${SERVICES_STATUS}\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Status*\n${{ steps.status.outputs.status_text }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Version*\n\`${{ needs.generate-version.outputs.version }}\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Duration*\n${DURATION_MIN}m ${DURATION_SEC}s\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch*\n\`${{ github.ref_name }}\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Triggered By*\n${{ github.actor }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*K8s Update*\n${{ needs.update-k8s-manifests.result }}\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Commit:* <${{ github.event.repository.html_url }}/commit/${{ github.sha }}|\`${GITHUB_SHA:0:7}\`>\n*View Run:* <${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}|Click here>\"
                  }
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"GitHub Actions ‚Ä¢ $(date -u +'%Y-%m-%d %H:%M:%S UTC')\"
                    }
                  ]
                }
              ]
            }"
          
          echo "‚úÖ Pipeline completion notification sent"
