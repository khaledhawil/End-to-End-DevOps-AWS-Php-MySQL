name: CI/CD Pipeline - AWS ECR

on:
  push:
    branches: [main, develop]
    paths:
      - 'services/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'services/**'

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  IMAGE_TAG: ${{ github.sha }}

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      auth-service: ${{ steps.filter.outputs.auth-service }}
      task-service: ${{ steps.filter.outputs.task-service }}
      frontend: ${{ steps.filter.outputs.frontend }}
      nginx: ${{ steps.filter.outputs.nginx }}
      any-change: ${{ steps.filter.outputs.any-change }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for service changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth-service:
              - 'services/auth-service/**'
            task-service:
              - 'services/task-service/**'
            frontend:
              - 'services/frontend/**'
            nginx:
              - 'services/nginx/**'
            any-change:
              - 'services/**'

  build-and-push:
    name: Build, Scan & Push
    needs: detect-changes
    if: needs.detect-changes.outputs.any-change == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: auth-service
            changed: ${{ needs.detect-changes.outputs.auth-service }}
            context: ./services/auth-service
            ecr_repo: task-manager-auth
          - service: task-service
            changed: ${{ needs.detect-changes.outputs.task-service }}
            context: ./services/task-service
            ecr_repo: task-manager-task
          - service: frontend
            changed: ${{ needs.detect-changes.outputs.frontend }}
            context: ./services/frontend
            ecr_repo: task-manager-frontend
          - service: nginx
            changed: ${{ needs.detect-changes.outputs.nginx }}
            context: ./services/nginx
            ecr_repo: task-manager-nginx
    steps:
      - name: Skip if no changes
        if: matrix.changed != 'true'
        run: |
          echo "â­ï¸ Skipping ${{ matrix.service }} - no changes detected"
          exit 0

      - name: Checkout code
        if: matrix.changed == 'true'
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        if: matrix.changed == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        if: matrix.changed == 'true'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR repository if not exists
        if: matrix.changed == 'true'
        run: |
          aws ecr describe-repositories --repository-names ${{ matrix.ecr_repo }} || \
          aws ecr create-repository --repository-name ${{ matrix.ecr_repo }} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256

      - name: Set up Docker Buildx
        if: matrix.changed == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        if: matrix.changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          push: false
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ matrix.ecr_repo }}:${{ env.IMAGE_TAG }}
            ${{ env.ECR_REGISTRY }}/${{ matrix.ecr_repo }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Scan image with Trivy
        if: matrix.changed == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/${{ matrix.ecr_repo }}:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security
        if: matrix.changed == 'true' && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-${{ matrix.service }}-results.sarif'
          category: ${{ matrix.service }}

      - name: Scan image with Snyk (Optional)
        if: matrix.changed == 'true' && false  # Set to true to enable Snyk
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ env.ECR_REGISTRY }}/${{ matrix.ecr_repo }}:${{ env.IMAGE_TAG }}
          args: --severity-threshold=high

      - name: Push to ECR
        if: matrix.changed == 'true'
        run: |
          echo "ðŸš€ Pushing ${{ matrix.service }} to ECR..."
          docker push ${{ env.ECR_REGISTRY }}/${{ matrix.ecr_repo }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.ECR_REGISTRY }}/${{ matrix.ecr_repo }}:latest
          echo "âœ… Successfully pushed ${{ matrix.service }}"

      - name: Save image info
        if: matrix.changed == 'true'
        run: |
          mkdir -p artifacts
          echo "${{ env.IMAGE_TAG }}" > artifacts/${{ matrix.service }}-tag.txt
          echo "${{ matrix.ecr_repo }}" > artifacts/${{ matrix.service }}-repo.txt
          echo "${{ env.ECR_REGISTRY }}/${{ matrix.ecr_repo }}:${{ env.IMAGE_TAG }}" > artifacts/${{ matrix.service }}-full-image.txt

      - name: Upload artifacts
        if: matrix.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-artifacts
          path: artifacts/

  update-k8s-manifests:
    name: Update K8s Manifests
    needs: [detect-changes, build-and-push]
    if: needs.detect-changes.outputs.any-change == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update K8s manifests with new images
        run: |
          echo "ðŸ“ Updating K8s deployment manifests..."
          
          # Auth Service
          if [ -f "artifacts/auth-service-artifacts/auth-service-full-image.txt" ]; then
            IMAGE=$(cat artifacts/auth-service-artifacts/auth-service-full-image.txt)
            echo "Updating auth-service to: $IMAGE"
            yq eval ".spec.template.spec.containers[0].image = \"$IMAGE\"" -i k8s/base/users-deployment.yaml
          fi
          
          # Task Service
          if [ -f "artifacts/task-service-artifacts/task-service-full-image.txt" ]; then
            IMAGE=$(cat artifacts/task-service-artifacts/task-service-full-image.txt)
            echo "Updating task-service to: $IMAGE"
            yq eval ".spec.template.spec.containers[0].image = \"$IMAGE\"" -i k8s/base/logout-deployment.yaml
          fi
          
          # Frontend
          if [ -f "artifacts/frontend-artifacts/frontend-full-image.txt" ]; then
            IMAGE=$(cat artifacts/frontend-artifacts/frontend-full-image.txt)
            echo "Updating frontend to: $IMAGE"
            yq eval ".spec.template.spec.containers[0].image = \"$IMAGE\"" -i k8s/base/frontend-deployment.yaml
          fi
          
          echo "âœ… K8s manifests updated"
          echo "ðŸ“‹ Changes:"
          git diff k8s/

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add k8s/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update K8s image tags [skip ci]
            
            Commit: ${{ github.sha }}
            Workflow: ${{ github.workflow }}
            
            Updated images:
            $(find artifacts -name '*-full-image.txt' -exec sh -c 'echo "- $(basename $(dirname {})): $(cat {})"' \;)
            "
            git push
          fi

  notify-success:
    name: Notify Success
    needs: [detect-changes, build-and-push, update-k8s-manifests]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Create deployment summary
        run: |
          echo "# âœ… CI/CD Pipeline Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Services Updated" >> $GITHUB_STEP_SUMMARY
          echo "- Auth Service: ${{ needs.detect-changes.outputs.auth-service == 'true' && 'âœ… Built & Pushed' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Task Service: ${{ needs.detect-changes.outputs.task-service == 'true' && 'âœ… Built & Pushed' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.detect-changes.outputs.frontend == 'true' && 'âœ… Built & Pushed' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Nginx: ${{ needs.detect-changes.outputs.nginx == 'true' && 'âœ… Built & Pushed' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Deployment Info" >> $GITHUB_STEP_SUMMARY
          echo "- Image Tag: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Registry: \`${{ env.ECR_REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
