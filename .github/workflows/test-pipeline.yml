name: Test CI Pipeline

on:
  workflow_dispatch:  # Manual trigger for testing

jobs:
  test-change-detection:
    name: Test Change Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need 2 commits to compare

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            services/**

      - name: List changed services
        run: |
          echo "ðŸ” Testing Change Detection"
          echo "=========================="
          echo ""
          echo "All changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          echo ""
          
          # Check each service
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "services/auth-service"; then
            echo "âœ… Auth Service - CHANGED"
          else
            echo "â­ï¸  Auth Service - No changes"
          fi
          
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "services/task-service"; then
            echo "âœ… Task Service - CHANGED"
          else
            echo "â­ï¸  Task Service - No changes"
          fi
          
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "services/frontend"; then
            echo "âœ… Frontend - CHANGED"
          else
            echo "â­ï¸  Frontend - No changes"
          fi
          
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "services/nginx"; then
            echo "âœ… Nginx - CHANGED"
          else
            echo "â­ï¸  Nginx - No changes"
          fi

  test-docker-build:
    name: Test Docker Build (Dry Run)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test build auth-service
        run: |
          echo "ðŸ—ï¸  Testing auth-service build..."
          docker build services/auth-service -t test-auth:latest
          echo "âœ… Auth service builds successfully"

      - name: Test build task-service
        run: |
          echo "ðŸ—ï¸  Testing task-service build..."
          docker build services/task-service -t test-task:latest
          echo "âœ… Task service builds successfully"

      - name: Test build frontend
        run: |
          echo "ðŸ—ï¸  Testing frontend build..."
          docker build services/frontend -t test-frontend:latest
          echo "âœ… Frontend builds successfully"

      - name: Test build nginx
        run: |
          echo "ðŸ—ï¸  Testing nginx build..."
          docker build services/nginx -t test-nginx:latest
          echo "âœ… Nginx builds successfully"

  test-trivy-scan:
    name: Test Trivy Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build test image
        run: |
          docker build services/nginx -t test-image:latest

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: test-image:latest
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: Show scan results
        run: |
          echo "âœ… Trivy scan completed"
          echo "Check logs above for vulnerabilities"

  pipeline-test-summary:
    name: Test Summary
    needs: [test-change-detection, test-docker-build, test-trivy-scan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create summary
        run: |
          echo "# ðŸ§ª CI Pipeline Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "- Change Detection: ${{ needs.test-change-detection.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Builds: ${{ needs.test-docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy Scan: ${{ needs.test-trivy-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-change-detection.result }}" == "success" ] && \
             [ "${{ needs.test-docker-build.result }}" == "success" ] && \
             [ "${{ needs.test-trivy-scan.result }}" == "success" ]; then
            echo "## âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your CI pipeline is ready to use! ðŸš€" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Add GitHub secrets (DOCKER_USERNAME, DOCKER_PASSWORD)" >> $GITHUB_STEP_SUMMARY
            echo "2. Enable the main ci-cd-pipeline.yml workflow" >> $GITHUB_STEP_SUMMARY
            echo "3. Make a change to any service and push" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above to debug issues." >> $GITHUB_STEP_SUMMARY
          fi
